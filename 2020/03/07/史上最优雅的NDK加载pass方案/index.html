<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ckcat.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="转载 : https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6643  关键词：  不需要编译llvm 仅依赖NDK，不需要额外的其他环境 不会遇到配置引起的符号NotFound问题 不污染NDK   一、背景介绍 二、使用NDK的环境编译一个pass 三、使用NDK的环境加载一个pass 四、当我们来到macOS上 五、当我们来到Windows 六、其他     一、背景介绍">
<meta property="og:type" content="article">
<meta property="og:title" content="史上最优雅的NDK加载pass方案">
<meta property="og:url" content="https://ckcat.github.io/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="CKCat的博客">
<meta property="og:description" content="转载 : https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6643  关键词：  不需要编译llvm 仅依赖NDK，不需要额外的其他环境 不会遇到配置引起的符号NotFound问题 不污染NDK   一、背景介绍 二、使用NDK的环境编译一个pass 三、使用NDK的环境加载一个pass 四、当我们来到macOS上 五、当我们来到Windows 六、其他     一、背景介绍">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ckcat.github.io/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/2020-03-07-00-33-38.png">
<meta property="article:published_time" content="2020-03-07T00:18:47.000Z">
<meta property="article:modified_time" content="2023-09-26T09:26:42.691Z">
<meta property="article:author" content="CKCat">
<meta property="article:tag" content="OLLVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ckcat.github.io/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/2020-03-07-00-33-38.png">


<link rel="canonical" href="https://ckcat.github.io/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ckcat.github.io/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/","path":"2020/03/07/史上最优雅的NDK加载pass方案/","title":"史上最优雅的NDK加载pass方案"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>史上最优雅的NDK加载pass方案 | CKCat的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CKCat的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">一、背景介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8NDK%E7%9A%84%E7%8E%AF%E5%A2%83%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AApass"><span class="nav-number">2.</span> <span class="nav-text">二、使用NDK的环境编译一个pass</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8NDK%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8A%A0%E8%BD%BD%E4%B8%80%E4%B8%AApass"><span class="nav-number">3.</span> <span class="nav-text">三、使用NDK的环境加载一个pass</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%BD%93%E6%88%91%E4%BB%AC%E6%9D%A5%E5%88%B0macOS%E4%B8%8A"><span class="nav-number">4.</span> <span class="nav-text">四、当我们来到macOS上</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%BD%93%E6%88%91%E4%BB%AC%E6%9D%A5%E5%88%B0Windows"><span class="nav-number">5.</span> <span class="nav-text">五、当我们来到Windows</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%85%B6%E4%BB%96"><span class="nav-number">6.</span> <span class="nav-text">六、其他</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CKCat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/CKCat" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CKCat" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ckcatck@qq.com" title="E-Mail → mailto:ckcatck@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ckcat.github.io/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CKCat">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CKCat的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="史上最优雅的NDK加载pass方案 | CKCat的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          史上最优雅的NDK加载pass方案
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-07 00:18:47" itemprop="dateCreated datePublished" datetime="2020-03-07T00:18:47+00:00">2020-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-26 09:26:42" itemprop="dateModified" datetime="2023-09-26T09:26:42+00:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OLLVM/" itemprop="url" rel="index"><span itemprop="name">OLLVM</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>转载 : <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6643">https://xz.aliyun.com/t/6643</a></p>
</blockquote>
<p>关键词：</p>
<ul>
<li>不需要编译llvm</li>
<li>仅依赖NDK，不需要额外的其他环境</li>
<li>不会遇到配置引起的符号NotFound问题</li>
<li>不污染NDK<!-- TOC --></li>
</ul>
<ul>
<li><a href="#%E4%B8%80%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D">一、背景介绍</a></li>
<li><a href="#%E4%BA%8C%E4%BD%BF%E7%94%A8ndk%E7%9A%84%E7%8E%AF%E5%A2%83%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AApass">二、使用NDK的环境编译一个pass</a></li>
<li><a href="#%E4%B8%89%E4%BD%BF%E7%94%A8ndk%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8A%A0%E8%BD%BD%E4%B8%80%E4%B8%AApass">三、使用NDK的环境加载一个pass</a></li>
<li><a href="#%E5%9B%9B%E5%BD%93%E6%88%91%E4%BB%AC%E6%9D%A5%E5%88%B0macos%E4%B8%8A">四、当我们来到macOS上</a></li>
<li><a href="#%E4%BA%94%E5%BD%93%E6%88%91%E4%BB%AC%E6%9D%A5%E5%88%B0windows">五、当我们来到Windows</a></li>
<li><a href="#%E5%85%AD%E5%85%B6%E4%BB%96">六、其他</a></li>
</ul>
<!-- /TOC -->


<h1 id="一、背景介绍"><a href="#一、背景介绍" class="headerlink" title="一、背景介绍"></a>一、背景介绍</h1><p>现在代码保护技术很多是在llvm上实现的，例如 ollvm 和 hikari，作者给出的实现是将源码混杂在llvm中，这样做非常不优雅。近来越来越多安全工作者都开始接触和研究基于llvm的代码保护，工欲善其事必先利其器，在编译、运行均是本机的环境下，不会出问题，因此本文介绍的是，如何优雅地在NDK中加载pass。</p>
<p>安卓开发者使用混淆技术来保护native代码时，一般有两种选择：</p>
<p>第一个选择是获得git上 ollvm 或 hikari 的代码，编译后，替换掉NDK中原先的toolchain。<br>这是最不优雅的方式，因为维护起来很麻烦，因为需要编译整个llvm工程，并且对NDK有侵入性，无法保证修改前和修改后NDK的功能不发生变化。</p>
<p>第二个选择是，编译llvm工程，替换掉NDK中原先的toolchain，并且在相同环境下，移植 ollvm 或hikari 为独立的plugin，（移植方案我的github里有写 <a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/llvm-pass-tutorial">https://github.com/LeadroyaL/llvm-pass-tutorial</a> ）用编译为插件的形式，动态加载插件。<br>相比第一个方案，极大降低维护的代价，只编译一个pass即可，但仍然对NDK有侵入性。</p>
<p>这两种方案的共同特点是：都需要编译整个llvm项目，初次部署时要消耗大量的时间和资源，另外在选择llvm版本时，也会纠结适配性的问题（虽然通常不会出现适配问题）</p>
<p>笔者曾经使用的是第二种方案，经过研究，本文提出第三种方案，使用NDK中的环境编译pass并加载pass，优雅程度上来看，有以下的特点：</p>
<ul>
<li>最最重要的，不需要编译llvm项目，节省巨大的时间和资源消耗；</li>
<li>其次，不修改原先的NDK运行环境，和原生的NDK是最像的，没有侵入性；</li>
<li>再次，上下文均和NDK完全一致，不需要担心符号问题，不需要额外安装软件和环境，有NDK的环境就足矣；</li>
</ul>
<p>本文演示的环境是：ubuntu18.04（任意linux均可）、ndk-r20（任意NDK版本均可）、cmake（选择较高版本）</p>
<h1 id="二、使用NDK的环境编译一个pass"><a href="#二、使用NDK的环境编译一个pass" class="headerlink" title="二、使用NDK的环境编译一个pass"></a>二、使用NDK的环境编译一个pass</h1><p>众所周知，编译Pass时需要使用llvm的环境，由于NDK中的llvm环境是破损的，所以开发者一般自己编译一份llvm环境出来，替换掉NDK中的llvm环境，包括我本人之前也是这样处理的，这样做的原因是NDK中的llvm是破损的，因为NDK来自AOSP编译好的toolchain，而AOSP在制作toolchain的过程中是移除了部分文件的。</p>
<p>上文提到，本文的方案是不需要亲自编译llvm的，因此就需要使用NDK中的破损的llvm环境来编译一个pass。</p>
<p>根据对 <a target="_blank" rel="noopener" href="https://android.googlesource.com/toolchain/llvm_android/">https://android.googlesource.com/toolchain/llvm_android/</a> 的阅读和调试，NDK中的llvm缺失的是一部分binary文件、全部静态链接库文件、全部头文件，采用的是静态连接的方式，它的clang是较为独立的文件（它会依赖libc++，因此成为较为独立）。</p>
<p>平时编译Pass时，需要使用cmake并且导入各种cmake相关的环境，通常写如下的配置文件，<a target="_blank" rel="noopener" href="https://github.com/abenkhadra/llvm-pass-tutorial/blob/master/CMakeLists.txt">https://github.com/abenkhadra/llvm-pass-tutorial/blob/master/CMakeLists.txt</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4)</span><br><span class="line"></span><br><span class="line"># we need LLVM_HOME in order not automatically set LLVM_DIR</span><br><span class="line">if(NOT DEFINED ENV&#123;LLVM_HOME&#125;)</span><br><span class="line">    message(FATAL_ERROR &quot;$LLVM_HOME is not defined&quot;)</span><br><span class="line">else ()</span><br><span class="line">    set(ENV&#123;LLVM_DIR&#125; $ENV&#123;LLVM_HOME&#125;/lib/cmake/llvm)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">find_package(LLVM REQUIRED CONFIG)</span><br><span class="line">add_definitions($&#123;LLVM_DEFINITIONS&#125;)</span><br><span class="line">include_directories($&#123;LLVM_INCLUDE_DIRS&#125;)</span><br><span class="line">link_directories($&#123;LLVM_LIBRARY_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">add_subdirectory(skeleton)  # Use your pass name here.</span><br></pre></td></tr></table></figure>
<p><strong>幸运的是</strong> ，NDK中的lib&#x2F;cmake&#x2F;llvm还在，里面的cmake文件都是原汁原味的的。</p>
<p><strong>不幸的是</strong> ，由于AOSP在编译toolchain时设置了 <code>defines[&#39;LLVM_LIBDIR_SUFFIX&#39;] = &#39;64&#39;</code> ，导致find_package的路径应该是 <code>lib64/cmake/llvm</code> ，需要稍加修改</p>
<p>之后进行 <code>mkdir b;cd b;cmake ..</code></p>
<p>会报如下的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  b git:(master) ✗ cmake ..</span><br><span class="line">CMake Error at /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/lib64/cmake/llvm/LLVMExports.cmake:806 (message):</span><br><span class="line">  The imported target &quot;LLVMDemangle&quot; references the file</span><br><span class="line"></span><br><span class="line">     &quot;/home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/lib64/libLLVMDemangle.a&quot;</span><br><span class="line">  but this file does not exist.  Possible reasons include:</span><br><span class="line">  * The file was deleted, renamed, or moved to another location.</span><br><span class="line">  * An install or uninstall procedure did not complete successfully.</span><br><span class="line">  * The installation package was faulty and contained</span><br><span class="line">     &quot;/home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/lib64/cmake/llvm/LLVMExports.cmake&quot;</span><br><span class="line"></span><br><span class="line">  but not all the files it references.</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/lib64/cmake/llvm/LLVMConfig.cmake:173 (include)</span><br><span class="line">  CMakeLists.txt:8 (find_package)</span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also &quot;/home/leadroyal/llvm-pass-tutorial/b/CMakeFiles/CMakeOutput.log&quot;.</span><br></pre></td></tr></table></figure>
<p>因为NDK不含有.a文件，而cmake会检查这些文件，用于静态连接，被认为初始化失败，出错。</p>
<p>看源码对应的位置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Loop over all imported files and verify that they actually exist</span><br><span class="line">foreach(target $&#123;_IMPORT_CHECK_TARGETS&#125; )</span><br><span class="line">  foreach(file $&#123;_IMPORT_CHECK_FILES_FOR_$&#123;target&#125;&#125; )</span><br><span class="line">    if(NOT EXISTS &quot;$&#123;file&#125;&quot; )</span><br><span class="line">      message(FATAL_ERROR &quot;The imported target \&quot;$&#123;target&#125;\&quot; references the file</span><br><span class="line">   \&quot;$&#123;file&#125;\&quot;</span><br><span class="line">but this file does not exist.  Possible reasons include:</span><br><span class="line">* The file was deleted, renamed, or moved to another location.</span><br><span class="line">* An install or uninstall procedure did not complete successfully.</span><br><span class="line">* The installation package was faulty and contained</span><br><span class="line">   \&quot;$&#123;CMAKE_CURRENT_LIST_FILE&#125;\&quot;</span><br><span class="line">but not all the files it references.</span><br><span class="line">&quot;)</span><br><span class="line">    endif()</span><br><span class="line">  endforeach()</span><br><span class="line">  unset(_IMPORT_CHECK_FILES_FOR_$&#123;target&#125;)</span><br><span class="line">endforeach()</span><br></pre></td></tr></table></figure>
<p>在文件不存在时，报 <code>message(FATAL_ERROR xxxxxx)</code>，从而中断编译，但我们本来就是编译动态链接库的，不需要.a文件，所以这里做一个patch，降低log_level，使用WARNING等级。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- message(FATAL_ERROR &quot;The imported target \&quot;$&#123;target&#125;\&quot; references the file</span><br><span class="line">+ message(WARNING &quot;The imported target \&quot;$&#123;target&#125;\&quot; references the file</span><br></pre></td></tr></table></figure>
<p>接下来面对第二个问题，之前提到过，NDK中缺失我们需要的头文件，它们本该出现在 <code>include/llvm</code> 中，因此这句话失效了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include_directories($&#123;LLVM_INCLUDE_DIRS&#125;)</span><br></pre></td></tr></table></figure>
<p>但我们又不能随便找一堆头文件过来，版本之间可能有变更，万一用到一些配置不一样的头文件，就会出现非预期（例如经常出错的LLVM_ENABLE_ABI_BREAKING_CHECKS配置）</p>
<p>此时的思路是，找到NDK中llvm生成时的那份commit，从中获取include文件，有两个方案</p>
<ul>
<li>第一个方案是找到源码并使用cmake帮我们提取一遍。</li>
<li>第二个方案是直接使用aosp提供的prebuilt文件，显然为了方便我们选择后者。<br>toolchain 在生成时会有一份描述版本信息的文件，在ndk生成时也被拷贝过来了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  linux-x86_64 cat /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/AndroidVersion.txt </span><br><span class="line">8.0.7</span><br><span class="line">based on r346389c</span><br></pre></td></tr></table></figure>
<strong>【AOSP相关访问google的前提条件你懂的】</strong></li>
</ul>
<p><code>r346389c</code> 就是这份toolchain的唯一标识，它与出现在 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/</a> 中的一系列clang-rxxxx是一回事，由于这个README.md经常被更新，我们需要checkout到对应的tag才可以找到它，<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/refs/tags/ndk-r20%E3%80%82">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/refs/tags/ndk-r20。</a></p>
<p>于是在 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/refs/tags/ndk-r20/clang-r346389c/include/">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/refs/tags/ndk-r20/clang-r346389c/include/</a> 中我们非常轻易就获取到了那份编译时刻的 <code>include/llvm</code> 和 <code>include/llvm-c</code> 文件，使用点击右上角的 tgz ，有用的只有 <code>llvm</code> 和 <code>llvm-c</code> ，另外的 <code>clang</code> 、<code>clang-c</code> 、<code>lld</code> 我们用不到我就不下载了。</p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/ndk-r20/clang-r346389c/include/llvm.tar.gz">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/ndk-r20/clang-r346389c/include/llvm.tar.gz</a></p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/ndk-r20/clang-r346389c/include/llvm-c.tar.gz">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/ndk-r20/clang-r346389c/include/llvm-c.tar.gz</a></p>
<p>即可获得到这个目录的压缩包。</p>
<p>mac 对应的目录是<br><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/darwin-x86/+/refs/tags/ndk-r20/clang-r346389c/include/">https://android.googlesource.com/platform/prebuilts/clang/host/darwin-x86/+/refs/tags/ndk-r20/clang-r346389c/include/</a></p>
<p>如果可以接受NDK被污染（我使用的是这个方案），可以将它放到NDK的toolchain中，这样就可以继续使用 <code>$&#123;LLVM_INCLUDE_DIRS&#125; </code>这个变量；</p>
<p>如果不能接受NDK被污染，就随便放个目录，使用 <code>include_directories(/path/to/clang-r346389c/include)</code></p>
<p>比如放在NDK里的include里，是这个样子（c++目录本来就有）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  include lsa</span><br><span class="line">total 5.4M</span><br><span class="line">drwxr-xr-x  8 leadroyal leadroyal 4.0K Oct 21 02:13 .</span><br><span class="line">drwxr-xr-x 15 leadroyal leadroyal 4.0K Oct 20 23:16 ..</span><br><span class="line">drwxr-xr-x  4 leadroyal leadroyal 4.0K Oct 21 02:12 c++</span><br><span class="line">drwxr-xr-x 33 leadroyal leadroyal 4.0K Oct 21 02:12 llvm</span><br><span class="line">drwxr-xr-x  3 leadroyal leadroyal 4.0K Oct 21 02:12 llvm-c</span><br></pre></td></tr></table></figure>
<p>然后有几率遇到C++版本的问题，llvm10以上需要添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br></pre></td></tr></table></figure>
<p>在这在情况下使用的CMakeLists.txt最终是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4)</span><br><span class="line">if(NOT DEFINED ENV&#123;LLVM_HOME&#125;)</span><br><span class="line">    message(FATAL_ERROR &quot;$LLVM_HOME is not defined&quot;)</span><br><span class="line">endif()</span><br><span class="line">if(NOT DEFINED ENV&#123;LLVM_DIR&#125;)</span><br><span class="line">    set(ENV&#123;LLVM_DIR&#125; $ENV&#123;LLVM_HOME&#125;/lib64/cmake/llvm)</span><br><span class="line">endif()</span><br><span class="line">find_package(LLVM REQUIRED CONFIG)</span><br><span class="line">add_definitions($&#123;LLVM_DEFINITIONS&#125;)</span><br><span class="line">include_directories($&#123;LLVM_INCLUDE_DIRS&#125;)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">add_subdirectory(skeleton)  # Use your pass name here.</span><br></pre></td></tr></table></figure>
<p>修复完include问题后，就可以舒舒服服地使用cmake来生成demo了，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">export LLVM_HOME=/home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64</span><br><span class="line">➜  b git:(master) ✗ cmake ..       </span><br><span class="line">-- The C compiler identification is GNU 7.4.0</span><br><span class="line">-- The CXX compiler identification is GNU 7.4.0</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/leadroyal/llvm-pass-tutorial/b</span><br><span class="line">➜  b git:(master) ✗ cmake --build .                    </span><br><span class="line">Scanning dependencies of target SkeletonPass</span><br><span class="line">[ 50%] Building CXX object skeleton/CMakeFiles/SkeletonPass.dir/Skeleton.cpp.o</span><br><span class="line">[100%] Linking CXX shared module libSkeletonPass.so</span><br><span class="line">[100%] Built target SkeletonPass</span><br></pre></td></tr></table></figure>

<h1 id="三、使用NDK的环境加载一个pass"><a href="#三、使用NDK的环境加载一个pass" class="headerlink" title="三、使用NDK的环境加载一个pass"></a>三、使用NDK的环境加载一个pass</h1><p>编译部分完成了，接下来是加载部分，我们随便找一个android native项目，修改build.gradle中的flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">externalNativeBuild &#123;</span><br><span class="line">    cmake &#123;</span><br><span class="line">        cppFlags &quot;-Xclang -load -Xclang /home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>gradle build</code> 命令后，可能会如下报错（当编译pass时使用了GNU系列的c++时候会遇到，常见于ubuntu，因为NDK使用的是llvm系列的c++）<br>如果出现如下报错的话，解决方案如下，如果没有报错，请跳过这部分</p>
<p>通常被搜索的关键词是：<code>_ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE</code></p>
<p><strong>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;GNU使用兼容libc++的方案（没遇到可以跳过） &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./gradlew build</span><br><span class="line">  error: unable to load plugin &#x27;/home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so&#x27;: &#x27;/home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so: undefined symbol: _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE&#x27;</span><br></pre></td></tr></table></figure>
<p>很奇怪，提醒这个符号找不到，但是我们编译时能找到、连接时找不到，就很奇怪。</p>
<p>demangle一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c++filt _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE</span><br><span class="line">llvm::FunctionPass::createPrinterPass(llvm::raw_ostream&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) const</span><br></pre></td></tr></table></figure>
<p>去NDK的相关目录下grep，发现了该符号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  lib64 pwd</span><br><span class="line">/home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/lib64</span><br><span class="line">➜  lib64 strings * | grep _ZNK4llvm12FunctionPass17createPrinterPass</span><br><span class="line">strings: Warning: &#x27;clang&#x27; is a directory</span><br><span class="line">strings: Warning: &#x27;cmake&#x27; is a directory</span><br><span class="line">_ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEE</span><br></pre></td></tr></table></figure>
<p>demangle一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c++filt _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEE</span><br><span class="line">llvm::FunctionPass::createPrinterPass(llvm::raw_ostream&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;) const</span><br></pre></td></tr></table></figure>
<p>对比一下二者，注意一个细节，参数命名空间不一致：<br>NDK里的叫 <code>std::__1::basic_string</code> ，我们编出来的叫 <code>std::__cxx11::basic_string</code></p>
<p>NDK里的叫 <code>std::__1::char_traits</code> ，我们编出来的叫 <code>std::char_traits</code></p>
<p>如果是老司机的话，一眼就知道它们使用了不同版本的c++，最初的源码是一致的，解决起来不难。</p>
<p>用 <code>__cxx11</code> 的叫 <code>libc++</code>，用 <code>__1</code> 叫 <code>libstdc++</code>。</p>
<p>解决方案是在连接时使用 <code>libc++</code> ，<code>set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -stdlib=libc++&quot;)</code> ，但由于ubuntu装的一般是gcc系列，而gcc系列是没有libc++的，编译会crash如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=/usr/bin/c++</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">c++: error: unrecognized command line option ‘-stdlib=libc++’</span><br></pre></td></tr></table></figure>
<p>gcc没有libc++，只有llvm系列拥有libc++，所以需要将编译器切换到clang。</p>
<p>重申我们之前的原则：不需要安装额外的软件，恰好NDK提供了一个clang给我们，为了方便我就用它提供的了（毕竟安装一个clang也挺麻烦的）</p>
<p>再使用libc++的头文件，也直接从对应的地方下载，但千万别和NDK的放在一起，因为 <code>libc++</code> 的 <code>c++/v11</code> 和NDK的 <code>c++/4.9.x</code>，放一起会冲突<br><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/ndk-r20/clang-r346389c/include/c++.tar.gz">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/ndk-r20/clang-r346389c/include/c++.tar.gz</a></p>
<p>我把libc++的头文件放在 <code>/home/leadroyal/Android/Sdk/r346389c/include/</code> 下</p>
<p>放好后对它进行include，在这在情况下使用的CMakeLists.txt最终是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4)</span><br><span class="line">set(CMAKE_C_COMPILER /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/bin/clang)</span><br><span class="line">set(CMAKE_CXX_COMPILER /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++)</span><br><span class="line">if(NOT DEFINED ENV&#123;LLVM_HOME&#125;)</span><br><span class="line">    message(FATAL_ERROR &quot;$LLVM_HOME is not defined&quot;)</span><br><span class="line">endif()</span><br><span class="line">if(NOT DEFINED ENV&#123;LLVM_DIR&#125;)</span><br><span class="line">    set(ENV&#123;LLVM_DIR&#125; $ENV&#123;LLVM_HOME&#125;/lib64/cmake/llvm)</span><br><span class="line">endif()</span><br><span class="line">find_package(LLVM REQUIRED CONFIG)</span><br><span class="line">add_definitions($&#123;LLVM_DEFINITIONS&#125;)</span><br><span class="line">include_directories($&#123;LLVM_INCLUDE_DIRS&#125;)</span><br><span class="line">include_directories(/home/leadroyal/Android/Sdk/r346389c/include/c++/v1)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line">set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -stdlib=libc++&quot;)</span><br><span class="line">add_subdirectory(skeleton)  # Use your pass name here.</span><br></pre></td></tr></table></figure>
<p>我们使用gcc和clang编译两份pass出来，对比一下前后的区别：</p>
<p>使用GCC编译出来的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  b git:(master) ✗ ldd skeleton/libSkeletonPass.so</span><br><span class="line">    linux-vdso.so.1 (0x00007ffc3c3d5000)</span><br><span class="line">    libstdc++.so.6 =&gt; /usr/lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007ff114c76000)</span><br><span class="line">    libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007ff114a5e000)</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff11466d000)</span><br><span class="line">    libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007ff1142cf000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007ff115205000)</span><br></pre></td></tr></table></figure>
<p>使用clang编译出来的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  b git:(master) ✗ ldd skeleton/libSkeletonPass.so</span><br><span class="line">    linux-vdso.so.1 (0x00007ffc369e2000)</span><br><span class="line">    libc++.so.1 =&gt; not found</span><br><span class="line">    libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f002042c000)</span><br><span class="line">    libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f0020214000)</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f001fe23000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007f00209d3000)</span><br></pre></td></tr></table></figure>
<p>虽然后者提醒libc++.so.1找不到，感觉很诧异，于是去查ndk clang的依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ldd /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/bin/clang</span><br><span class="line">    linux-vdso.so.1 (0x00007ffc99bc7000)</span><br><span class="line">    libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f3bb9d24000)</span><br><span class="line">    libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f3bb9b07000)</span><br><span class="line">    librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f3bb98ff000)</span><br><span class="line">    libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f3bb96fb000)</span><br><span class="line">    libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f3bb935d000)</span><br><span class="line">    libc++.so.1 =&gt; /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/bin/../lib64/libc++.so.1 (0x00007f3bba07e000)</span><br><span class="line">    libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f3bb9145000)</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f3bb8d54000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007f3bb9f43000)</span><br></pre></td></tr></table></figure>
<p>发现在NDK里确实存在libc++.so.1环境，问题解决，我们回归主题，最后一步，使用NDK加载它！</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;GNU使用兼容libc++的方案 end &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>我们先用简单的c文件验证我们的pass，没有任何问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  /tmp cat test.c</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">int main()&#123;</span><br><span class="line">printf(&quot;HelloWorld\n&quot;);</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line">➜  /tmp /home/leadroyal/Android/Sdk/ndk/20.0.5594570/toolchains/llvm/prebuilt/linux-x86_64/bin/clang -Xclang -load -Xclang /home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so test.c </span><br><span class="line">I saw a function called main!</span><br><span class="line">➜  /tmp ./a.out </span><br><span class="line">HelloWorld</span><br></pre></td></tr></table></figure>
<p>最后一步，见证奇迹的时刻！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  MyApplication ./gradlew clean build</span><br><span class="line">............</span><br><span class="line">&gt; Task :app:externalNativeBuildDebug</span><br><span class="line">Build native-lib_armeabi-v7a</span><br><span class="line">ninja: Entering directory `/home/leadroyal/AndroidStudioProjects/MyApplication/app/.cxx/cmake/debug/armeabi-v7a&#x27;</span><br><span class="line">[1/2] Building CXX object CMakeFiles/native-lib.dir/native-lib.cpp.o</span><br><span class="line">I saw a function called Java_com_example_myapplication_MainActivity_stringFromJNI!</span><br><span class="line">I saw a function called _ZNSt6__ndk112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEC2EPKc!</span><br><span class="line">I saw a function called _ZN7_JNIEnv12NewStringUTFEPKc!</span><br><span class="line">I saw a function called _ZNKSt6__ndk112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE5c_strEv!</span><br><span class="line">I saw a function called _ZNSt6__ndk112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEED2Ev!</span><br></pre></td></tr></table></figure>
<p>泪流满面！我们终于成功编译并且加载了这个Pass!</p>
<h1 id="四、当我们来到macOS上"><a href="#四、当我们来到macOS上" class="headerlink" title="四、当我们来到macOS上"></a>四、当我们来到macOS上</h1><p>同Linux一样，先修复cmake文件，再下载include&#x2F;llvm和incude&#x2F;llvm-c，因为macOS默认就是clang了，所以不会存在libstdc++和libc++冲突的问题，编译过程全程没有任何障碍。</p>
<p>但是在加载时却遇到了如下的错误，也是在网上经常被贴出来问问题的报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  /tmp $ANDROID_NDK/20.0.5594570/toolchains/llvm/prebuilt/darwin-x86_64/bin/clang -Xclang -load -Xclang /home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so test.c</span><br><span class="line">error: unable to load plugin &#x27;/home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so&#x27;:</span><br><span class="line">      &#x27;dlopen(/home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so, 9): Symbol not found:</span><br><span class="line">      __ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE</span><br><span class="line">  Referenced from: /home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so</span><br><span class="line">  Expected in: flat namespace</span><br><span class="line"> in /home/leadroyal/llvm-pass-tutorial/b/skeleton/libSkeletonPass.so&#x27;</span><br></pre></td></tr></table></figure>
<p>demangle一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c++filt __ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE</span><br><span class="line">llvm::FunctionPass::assignPassManager(llvm::PMStack&amp;, llvm::PassManagerType)</span><br></pre></td></tr></table></figure>
<p>这个符号是llvm中导出的符号，供开发者调用，libSkeletonPass.so需要该符号，但是clang的进程空间里没有这个符号。</p>
<p>经过仔细对照，发现不仅仅缺失这一个符号，缺失的是一大堆相关的符号，而且都是较为基础的符号，只是最先被寻找的是这个就停下来了。<br>【先剧透一下，这个符号缺失是apple基础工具的bug，但是google没有发现这个bug，已报告<a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/143160164%E3%80%91">https://issuetracker.google.com/issues/143160164】</a></p>
<p>这时有另一个线索：我们自己编译出来的pass是可以正常加载pass的，一定是AOSP动了手脚，这里省去大量的diff时间，直接说结果。</p>
<p>记作X：使用llvm默认配置（与Android无关）编译出来的clang，可以找到符号</p>
<p>记作Y：使用AOSP得到的stage2-install&#x2F;bin&#x2F;clang，可以找到符号</p>
<p>记作Z：使用AOSP得到的toolchain中的clang，无法找到符号</p>
<p>X&#x2F;Y 可以说明， <a target="_blank" rel="noopener" href="https://android.googlesource.com/toolchain/llvm_android/">https://android.googlesource.com/toolchain/llvm_android/</a> 中对llvm的编译配置，是不影响符号的<br>Y&#x2F;Z 可以说明，strip前和strip后会导致符号缺失。在ubuntu上符号仍然被保留，在macOS上符号会消失。</p>
<p>代码如下 <a target="_blank" rel="noopener" href="https://android.googlesource.com/toolchain/llvm_android/+/refs/heads/master/build.py">https://android.googlesource.com/toolchain/llvm_android/+/refs/heads/master/build.py</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for bin_filename in os.listdir(bin_dir):</span><br><span class="line">        binary = os.path.join(bin_dir, bin_filename)</span><br><span class="line">        if os.path.isfile(binary):</span><br><span class="line">            if bin_filename not in necessary_bin_files:</span><br><span class="line">                remove(binary)</span><br><span class="line">            elif strip and bin_filename not in script_bins:</span><br><span class="line">                check_call([&#x27;strip&#x27;, binary])</span><br></pre></td></tr></table></figure>
<p>之后我将X进行 <code>/usr/bin/strip</code> ，发现仍然可以加载pass，这时就开始犯晕，开始缺乏思路。</p>
<p>于是出现了另一个可能引发问题的原因：我编译X、strip-X都是在CommandLineTools 10.15上完成的，但编译Y、strip-Y是在CommandLineTools 10.13上完成的，二者的strip不完全一致！</p>
<p>经过最后一个实验，发现低版本的&#x2F;usr&#x2F;bin&#x2F;strip会错误地移除掉很多符号，导致加载失败，日志如下，我分别用10.13&#x2F;10.14&#x2F;10.15的strip去处理stage2-install&#x2F;bin&#x2F;clang文件，发现10.13&#x2F;14处理出来的文件是错误的。</p>
<img src="/2020/03/07/%E5%8F%B2%E4%B8%8A%E6%9C%80%E4%BC%98%E9%9B%85%E7%9A%84NDK%E5%8A%A0%E8%BD%BDpass%E6%96%B9%E6%A1%88/2020-03-07-00-33-38.png" class="">

<p>至此，真相大白，失败的原因是：AOSP在编译NDK时触发了macOS自带的strip的bug。</p>
<p>最后的挣扎：NDK中存在一个完备的、拥有符号的文件 LLVM.dylib 中的，如果我们让libSkeleton.so依赖它，从LLVM.dylib中获取符号会怎样？<br>最终结果是，关键变量PassManager在NDK-clang中是没有符号的，虽然在LLVM.dylib中可以找到，但二者已经完全不是同一个instance了。</p>
<p>因此，macOS宣告失败，等将来AOSP把这个bug修掉，就可以复用史上最优雅的方法了。</p>
<h1 id="五、当我们来到Windows"><a href="#五、当我们来到Windows" class="headerlink" title="五、当我们来到Windows"></a>五、当我们来到Windows</h1><p>对不起，能力有限告辞。。。</p>
<h1 id="六、其他"><a href="#六、其他" class="headerlink" title="六、其他"></a>六、其他</h1><p>不想看到的事情：</p>
<p>根据这次commit，开发者建议砍掉toolchain里的.cmake文件，因为作者已经砍掉.a文件了，防止.cmake加载失败引起的误会。我也是弄完这一系列才看到这条commit，于是想尽自己的绵薄之力回滚一下，希望能成功吧。</p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/toolchain/llvm_android/+/5e612035111cb9f4abad43697350d4ea644fce33">https://android.googlesource.com/toolchain/llvm_android/+/5e612035111cb9f4abad43697350d4ea644fce33</a><br><a target="_blank" rel="noopener" href="https://android-review.googlesource.com/c/toolchain/llvm_android/+/1139155">https://android-review.googlesource.com/c/toolchain/llvm_android/+/1139155</a><br>以及，开发者建议砍掉ndk里的.cmake文件，体现在这次commit里</p>
<p><a target="_blank" rel="noopener" href="https://android-review.googlesource.com/c/platform/ndk/+/1137192">https://android-review.googlesource.com/c/platform/ndk/+/1137192</a><br>反正ndk-r21肯定是没有cmake了，到时候就从toolchain里下载回来吧。</p>
<p>本文介绍了一种非常优雅的NDK加载Pass方案，目前从未听说国内外有人使用该方案，感觉非常有意义，在此分享出来，希望更多人可以用到它、共同推动安全行业的发展，完结撒花~</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://leadroyal.cn/">https://leadroyal.cn</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/OLLVM/" rel="tag"># OLLVM</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/03/05/github%E9%A1%B9%E7%9B%AE%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7/" rel="prev" title="github项目搜索技巧">
                  <i class="fa fa-chevron-left"></i> github项目搜索技巧
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/03/13/dexsim%E6%8F%92%E4%BB%B6-Geost/" rel="next" title="dexsim插件-Geost">
                  dexsim插件-Geost <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CKCat</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/CKCat" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
