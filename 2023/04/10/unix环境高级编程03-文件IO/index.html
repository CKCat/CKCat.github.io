<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ckcat.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="引言UNIX 系统中的大多数文件 I&#x2F;O 只需用到 5 个函数：open、read、write、lseek 以及 close。这些函数为不带缓冲的 I&#x2F;O，是 POSIX.1 和 Single UNIX Specification 的组成部分。 文件描述符对于内核而言，所有打开的文件都通过文件描述符引用。文件描述符是一个非负整数。文件描述符的变化范围是 0 ~ OPEN_MAX-1。现代操作系统文">
<meta property="og:type" content="article">
<meta property="og:title" content="unix环境高级编程03-文件IO">
<meta property="og:url" content="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/index.html">
<meta property="og:site_name" content="CKCat的博客">
<meta property="og:description" content="引言UNIX 系统中的大多数文件 I&#x2F;O 只需用到 5 个函数：open、read、write、lseek 以及 close。这些函数为不带缓冲的 I&#x2F;O，是 POSIX.1 和 Single UNIX Specification 的组成部分。 文件描述符对于内核而言，所有打开的文件都通过文件描述符引用。文件描述符是一个非负整数。文件描述符的变化范围是 0 ~ OPEN_MAX-1。现代操作系统文">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/%E4%B8%A4%E4%B8%AA%E7%8B%AC%E7%AB%8B%E8%BF%9B%E7%A8%8B%E5%90%84%E8%87%AA%E6%89%93%E5%BC%80%E5%90%8C%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/dup%E5%90%8E%E7%9A%84%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png">
<meta property="article:published_time" content="2023-04-10T17:20:28.000Z">
<meta property="article:modified_time" content="2023-09-15T12:58:33.106Z">
<meta property="article:author" content="CKCat">
<meta property="article:tag" content="unix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png">


<link rel="canonical" href="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/","path":"2023/04/10/unix环境高级编程03-文件IO/","title":"unix环境高级编程03-文件IO"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>unix环境高级编程03-文件IO | CKCat的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CKCat的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">2.</span> <span class="nav-text">文件描述符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-open-%E6%88%96-openat"><span class="nav-number">3.</span> <span class="nav-text">函数 open 或 openat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-creat"><span class="nav-number">4.</span> <span class="nav-text">函数 creat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-close"><span class="nav-number">5.</span> <span class="nav-text">函数 close</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-lseek"><span class="nav-number">6.</span> <span class="nav-text">函数 lseek</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-read"><span class="nav-number">7.</span> <span class="nav-text">函数 read</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-write"><span class="nav-number">8.</span> <span class="nav-text">函数 write</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-O-%E7%9A%84%E6%95%88%E7%8E%87"><span class="nav-number">9.</span> <span class="nav-text">I&#x2F;O 的效率</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB"><span class="nav-number">10.</span> <span class="nav-text">文件共享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-number">11.</span> <span class="nav-text">原子操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-dup-%E5%92%8C-dup2"><span class="nav-number">12.</span> <span class="nav-text">函数 dup 和 dup2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-sync%E3%80%81fsync-%E5%92%8C-fdatasync"><span class="nav-number">13.</span> <span class="nav-text">函数 sync、fsync 和 fdatasync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-fcntl"><span class="nav-number">14.</span> <span class="nav-text">函数 fcntl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-ioctl"><span class="nav-number">15.</span> <span class="nav-text">函数 ioctl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dev-fd"><span class="nav-number">16.</span> <span class="nav-text">&#x2F;dev&#x2F;fd</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CKCat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">112</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/CKCat" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CKCat" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ckcatck@qq.com" title="E-Mail → mailto:ckcatck@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ckcat.github.io/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CKCat">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CKCat的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="unix环境高级编程03-文件IO | CKCat的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          unix环境高级编程03-文件IO
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-10 17:20:28" itemprop="dateCreated datePublished" datetime="2023-04-10T17:20:28+00:00">2023-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-15 12:58:33" itemprop="dateModified" datetime="2023-09-15T12:58:33+00:00">2023-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">unix环境高级编程</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>UNIX 系统中的大多数文件 <code>I/O</code> 只需用到 5 个函数：<code>open</code>、<code>read</code>、<code>write</code>、<code>lseek</code> 以及 <code>close</code>。这些函数为不带缓冲的 <code>I/O</code>，是 <code>POSIX.1 </code>和 <code>Single UNIX Specification</code> 的组成部分。</p>
<h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p>对于内核而言，所有打开的文件都通过文件描述符引用。<strong>文件描述符是一个非负整数。</strong>文件描述符的变化范围是 <code>0 ~ OPEN_MAX-1</code>。<strong>现代操作系统文件描述符的变化范围几乎是无限的。</strong></p>
<p>文件描述符 0、1、2 分别表示标准输入、标准输出和标准错误。其对应的符号常量 <code>STDIN_FILENO</code>、<code>STDOUT_FILENO</code> 和 <code>STDERR_FILENO</code>，需要包含 <code>&lt;unistd.h&gt;</code> 头文件。</p>
<h2 id="函数-open-或-openat"><a href="#函数-open-或-openat" class="headerlink" title="函数 open 或 openat"></a>函数 open 或 openat</h2><p><code>open</code> 或 <code>openat</code> 函数可以打开或创建一个文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">int</span> oflag,... <span class="comment">/* mode_t mode */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">openat</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *path, <span class="type">int</span> oflag, ... <span class="comment">/* mode_t mode */</span> )</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>若成功，返回文件描述符；</li>
<li>若出错，返回 −1。</li>
</ul>
<p>参数：</p>
<ul>
<li>path：要打开或创建文件的名字。</li>
<li>oflag：打开的多种选项。</li>
<li>fd：文件描述符。</li>
</ul>
<p>说明：</p>
<p>oflag 参数必须指定下面 5 个选项的一个且只能指定一个。</p>
<ul>
<li><code>O_RDONLY</code> 只读打开。</li>
<li><code>O_WRONLY</code> 只写打开。</li>
<li><code>O_RDWR</code> 读、写打开。</li>
<li><code>O_EXEC</code> 只执行打开。</li>
<li><code>O_SEARCH</code> 只搜索打开（应用于目录），目前操作系统不支持。</li>
</ul>
<p>下面的选项对 oflag 参数是可选的。</p>
<ul>
<li><code>O_APPEND</code> 每次写时都追加到文件的尾端。</li>
<li><code>O_CLOEXEC</code> 把 <code>FD_CLOEXEC</code> 常量设置为文件描述符标志。</li>
<li><code>O_CREAT</code> 若此文件不存在则创建它。如果指定该选项，则需要同时使用 mode 参数指定新文件的权限。</li>
<li><code>O_DIRECTORY</code> 如果 path 引用的不是目录，则出错。</li>
<li><code>O_EXCL</code> 如果同时指定了 <code>O_CREAT</code>，而文件已经存在，则出错。</li>
<li><code>O_NOCTTY</code> 如果 path 引用的是终端设备，则不将该设备分配作为此进程的控制终端。</li>
<li><code>O_NOFOLLOW</code> 如果 path 引用的是一个符号链接，则出错。</li>
<li><code>O_NONBLOCK</code> 如果 path 引用的是一个 <code>FIFO</code>、一个块特殊文件或一个字符特殊文件，则此选项为文件的本次打开操作和后续的 <code>I/O</code> 操作设置非阻塞方式。</li>
<li><code>O_SYNC</code> 使每次 <code>write</code> 等待物理 <code>I/O</code> 操作完成</li>
<li><code>O_TRUNC</code> 如果此文件存在，而且为只写或读-写成功打开，则将其长度截断为 0。</li>
<li><code>O_TTY_INIT</code> 如果打开一个还未打开的终端设备，设置非标准 termios 参数值，使其符合 Single UNIX Specification。</li>
<li><code>O_DSYNC</code> 使每次 <code>write</code> 要等待物理 <code>I/O</code> 操作完成，但是如果该写操作并不影响读取刚写入的数据，则不需等待文件属性被更新。</li>
<li><code>O_RSYNC</code> 使每一个以文件描述符作为参数进行的 read 操作等待，直至所有对文件同一部分挂起的写操作都完成。</li>
</ul>
<p>fd 参数把 <code>open</code> 和 <code>openat</code> 函数区分开，共有 3 种可能性。</p>
<ul>
<li>path 参数指定的是绝对路径名，在这种情况下，fd 参数被忽略，<code>openat</code> 函数就相当于 <code>open</code> 函数。</li>
<li>path 参数指定的是相对路径名，fd 参数指出了相对路径名在文件系统中的开始地址。</li>
<li>path 参数指定了相对路径名，fd 参数具有特殊值 <code>AT_FDCWD</code>。</li>
</ul>
<p>mode 参数是可变参数, 表示文件访问权限。对于 open 函数而言，仅当创建新文件时才使用最后这个参数。</p>
<p>文件访问权限常量在 <code>&lt;sys/stat.h&gt;</code> 中定义，有下列九个：</p>
<ul>
<li><code>S_IRUSR</code>：用户读。</li>
<li><code>S_IWUSR</code>：用户写。</li>
<li><code>S_IXUSR</code>：用户执行。</li>
<li><code>S_IRGRP</code>：组读。</li>
<li><code>S_IWGRP</code>：组写。</li>
<li><code>S_IXGRP</code>：组执行。</li>
<li><code>S_IROTH</code>：其他读。</li>
<li><code>S_IWOTH</code>：其他写。</li>
<li><code>S_IXOTH</code>：其他执行。</li>
</ul>
<p>由 <code>open</code> 和 <code>openat</code> 函数返回的文件描述符一定是最小的未用描述符数值。</p>
<p><code>openat</code> 函数是 <code>POSIX.1</code> 最新版本中新增的一类函数之一，希望解决两个问题。</p>
<ol>
<li>让线程可以使用相对路径名打开目录中的文件，而不再只能打开当前工作目录。</li>
<li>可以避免 time-of-check-to-time-of-use（TOCTTOU）错误。</li>
</ol>
<p>例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">open_with_mode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">int</span> oflag, <span class="type">mode_t</span> mode)</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(path, oflag, mode);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;打开文件失败.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">open_without_mode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">int</span> oflag)</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(path, oflag);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;打开文件失败.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_content</span><span class="params">(<span class="type">char</span>* path)</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = open_without_mode(path, O_RDONLY);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">ssize_t</span> n = read(fd, buf, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;读取文件失败.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buf[n] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_content</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span>* content, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> n =  write(fd, content, len);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;写入文件失败.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 打开 hello.txt 文件,不存在则出错</span></span><br><span class="line">    open_without_mode(<span class="string">&quot;hello.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    open_without_mode(<span class="string">&quot;hello.txt&quot;</span>, O_RDWR);</span><br><span class="line">    open_without_mode(<span class="string">&quot;hello.txt&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="comment">// 创建 hello.txt 文件，</span></span><br><span class="line">    <span class="type">int</span> fd = open_with_mode(<span class="string">&quot;hello.txt&quot;</span>, O_RDWR|O_CREAT, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);</span><br><span class="line">    write_content(fd, <span class="string">&quot;hello&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    read_content(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// 追加打开</span></span><br><span class="line">    fd = open_without_mode(<span class="string">&quot;hello.txt&quot;</span>, O_RDWR|O_APPEND);</span><br><span class="line">    write_content(fd, <span class="string">&quot;world&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    read_content(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    fd = open_without_mode(<span class="string">&quot;./&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="type">int</span> fd2 = openat(fd, <span class="string">&quot;hello.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd2 = %d\n&quot;</span>, fd2);</span><br><span class="line">    <span class="comment">// O_TRUNC</span></span><br><span class="line">    open_without_mode(<span class="string">&quot;hello.txt&quot;</span>, O_TRUNC);</span><br><span class="line">    read_content(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// 删除 hello.txt 文件</span></span><br><span class="line">    <span class="type">int</span> ret = unlink(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;删除文件失败.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ gcc 01open.c</span><br><span class="line">$ ./a.out</span><br><span class="line">打开文件失败.: No such file or directory</span><br><span class="line">打开文件失败.: No such file or directory</span><br><span class="line">打开文件失败.: No such file or directory</span><br><span class="line">hello</span><br><span class="line">helloworld</span><br><span class="line">fd2 = 4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="函数-creat"><a href="#函数-creat" class="headerlink" title="函数 creat"></a>函数 creat</h2><p>creat 函数创建一个新文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">creat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure>

<p>此函数等效于：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open(path, O_WRONLY｜O_CREAT｜O_TRUNC, mode);</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>若成功，返回为只写打开的文件描述符；</li>
<li>若出错，返回 −1。</li>
</ul>
<p><code>creat</code> 的一个不足之处是它以只写方式打开所创建的文件。</p>
<p>例子:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="comment">// 创建一个新文件，如果文件已存在，则截断它，只写模式</span></span><br><span class="line">    fd = creat(<span class="string">&quot;hello.txt&quot;</span>, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法创建文件&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;成功创建文件\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 关闭文件</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 open 达到同样的效果</span></span><br><span class="line">    fd = open(<span class="string">&quot;hello.txt&quot;</span>, O_WRONLY | O_CREAT | O_TRUNC, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法创建文件&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;成功创建文件\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 关闭文件</span></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="comment">// 删除文件</span></span><br><span class="line">    unlink(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc 02creat.c</span><br><span class="line">$ ./a.out</span><br><span class="line">成功创建文件</span><br><span class="line">成功创建文件</span><br></pre></td></tr></table></figure>

<h2 id="函数-close"><a href="#函数-close" class="headerlink" title="函数 close"></a>函数 close</h2><p>close 函数关闭一个打开文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span> <span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>若成功，返回 0；</li>
<li>若出错，返回 −1。</li>
</ul>
<p>关闭一个文件时还会释放该进程加在该文件上的所有记录锁。当一个进程终止时，内核自动关闭它所有的打开文件。</p>
<h2 id="函数-lseek"><a href="#函数-lseek" class="headerlink" title="函数 lseek"></a>函数 lseek</h2><p>每个打开文件都有一个与其相关联的当前文件偏移量，调用 <code>lseek</code> 显式地为一个打开文件设置偏移量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">off_t</span> <span class="title function_">lseek</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> offset, <span class="type">int</span> whence)</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>若成功，返回新的文件偏移量；</li>
<li>若出错，返回为 −1。</li>
</ul>
<p>对参数 offset 的解释与参数 whence 的值有关。</p>
<ul>
<li>若 whence 是 <code>SEEK_SET</code>，则将该文件的偏移量设置为距文件开始处 offset 个字节。</li>
<li>若 whence 是 <code>SEEK_CUR</code>，则将该文件的偏移量设置为其当前值加 offset，offset 可正可负。</li>
<li>若 whence 是 <code>SEEK_END</code>，则将该文件的偏移量设置为文件长度加 offset，offset 可正可负。</li>
</ul>
<p>如果文件描述符指向的是一个管道、<code>FIFO</code> 或网络套接字，则 <code>lseek</code> 返回 −1，并将 <code>errno</code> 设置为 <code>ESPIPE</code> 。</p>
<p>例子，测试对其标准输入能否设置偏移量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(lseek(STDIN_FILENO, <span class="number">0</span>, SEEK_CUR) == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;cannot, seek\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;seek ok.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc 03lseek.c</span><br><span class="line">$ ./a.out</span><br><span class="line">cannot, seek</span><br></pre></td></tr></table></figure>

<p>比较 <code>lseek</code> 的返回值时应当谨慎，不要测试它是否小于 0，而要测试它是否等于 −1。</p>
<p><code>lseek</code> 仅将当前的文件偏移量记录在内核中，它并不引起任何 <code>I/O</code> 操作。</p>
<p>文件偏移量可以大于文件的当前长度，在这种情况下，对该文件的下一次写将加长该文件，并在文件中构成一个空洞，这一点是允许的。位于文件中但没有写过的字节都被读为 0。文件中的空洞并不要求在磁盘上占用存储区。</p>
<p>例子，创建一个具有空洞的文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf1[] = <span class="string">&quot;abcdefghij&quot;</span>;</span><br><span class="line"><span class="type">char</span> buf2[] = <span class="string">&quot;ABCDEFGHIJ&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span>((fd = creat(<span class="string">&quot;file.hole&quot;</span>, <span class="number">0644</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;creat error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(write(fd, buf1, <span class="number">10</span>) != <span class="number">10</span>) &#123; <span class="comment">// offset = 10</span></span><br><span class="line">        perror(<span class="string">&quot;buf1 write error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lseek(fd, <span class="number">16384</span>, SEEK_SET) == <span class="number">-1</span>)&#123; <span class="comment">// offset = 16384 = 0x4000</span></span><br><span class="line">        perror(<span class="string">&quot;lseek error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(write(fd, buf2, <span class="number">10</span>) != <span class="number">10</span>)&#123; <span class="comment">// offset = 16394</span></span><br><span class="line">        perror(<span class="string">&quot;buf2 write error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ gcc 04lseek_hole.c</span><br><span class="line">$ ./a.out</span><br><span class="line">$ <span class="built_in">ls</span> -l file.hole</span><br><span class="line">-rw-r--r-- 1 ckcat ckcat 16394 Apr 15 02:51 file.hole</span><br><span class="line">$ <span class="built_in">od</span> -c file.hole</span><br><span class="line">0000000   a   b   c   d   e   f   g   h   i   j  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000020  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">*</span><br><span class="line">0040000   A   B   C   D   E   F   G   H   I   J</span><br><span class="line">0040012</span><br></pre></td></tr></table></figure>

<p>再创建一个同样长度的非空洞文件，将其与空洞文件进行比较。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=file.nohole bs=16394 count=1</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">16394 bytes (16 kB, 16 KiB) copied, 0.000239963 s, 68.3 MB/s</span><br><span class="line">$ <span class="built_in">ls</span> -<span class="built_in">ls</span> file.hole file.nohole</span><br><span class="line"> 8 -rw-r--r-- 1 ckcat ckcat 16394 Apr 15 02:51 file.hole</span><br><span class="line">20 -rw-rw-r-- 1 ckcat ckcat 16394 Apr 15 02:55 file.nohole</span><br></pre></td></tr></table></figure>

<p>虽然两个文件的长度相同，但无空洞的文件占用了 20 个磁盘块，而具有空洞的文件只占用 8 个磁盘块。</p>
<h2 id="函数-read"><a href="#函数-read" class="headerlink" title="函数 read"></a>函数 read</h2><p><code>read</code> 函数从打开文件中读数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes)</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>读到的字节数，若已到文件尾，返回 0；</li>
<li>若出错，返回 −1。</li>
</ul>
<p>有多种情况可使实际读到的字节数少于要求读的字节数：</p>
<ul>
<li>读普通文件时，在读到要求字节数之前已到达了文件尾端。</li>
<li>当从终端设备读时，通常一次最多读一行。</li>
<li>当从网络读时，网络中的缓冲机制可能造成返回值小于所要求读的字节数。</li>
<li>当从管道或 <code>FIFO</code> 读时，如若管道包含的字节少于所需的数量，那么 <code>read</code> 将只返回实际可用的字节数。</li>
<li>当从某些面向记录的设备（如磁带）读时，一次最多返回一个记录。</li>
<li>当一信号造成中断，而已经读了部分数据量时。</li>
</ul>
<h2 id="函数-write"><a href="#函数-write" class="headerlink" title="函数 write"></a>函数 write</h2><p><code>write</code> 函数向打开文件写数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes)</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>若成功，返回已写的字节数；</li>
<li>若出错，返回 −1。</li>
</ul>
<p>其返回值通常与参数 nbytes 的值相同，否则表示出错。</p>
<h2 id="I-O-的效率"><a href="#I-O-的效率" class="headerlink" title="I/O 的效率"></a><code>I/O</code> 的效率</h2><p>大多数文件系统为改善性能都采用某种预读（read ahead）技术。当检测到正进行顺序读取时，系统就试图读入比应用所要求的更多数据，并假想应用很快就会读这些数据。</p>
<h2 id="文件共享"><a href="#文件共享" class="headerlink" title="文件共享"></a>文件共享</h2><p>UNIX 系统支持在不同进程间共享打开文件。</p>
<p>内核使用 3 种数据结构表示打开文件，它们之间的关系决定了在文件共享方面一个进程对另一个进程可能产生的影响。</p>
<ol>
<li>每个进程在进程表中都有一个记录项，记录项中包含一张打开文件描述符表：</li>
</ol>
<ul>
<li>文件描述符标志；</li>
<li>指向一个文件表项的指针。</li>
</ul>
<ol start="2">
<li>内核为所有打开文件维持一张文件表。每个文件表项包含：</li>
</ol>
<ul>
<li>文件状态标志</li>
<li>当前文件偏移量；</li>
<li>指向该文件 v 节点表项的指针。</li>
</ul>
<ol start="3">
<li>每个打开文件（或设备）都有一个 v 节点（v-node）结构。v 节点包含了文件类型和对此文件进行各种操作函数的指针。对于大多数文件，v 节点还包含了该文件的 i 节点（i-node，索引节点）。</li>
</ol>
<img src="/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" class="">

<img src="/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/%E4%B8%A4%E4%B8%AA%E7%8B%AC%E7%AB%8B%E8%BF%9B%E7%A8%8B%E5%90%84%E8%87%AA%E6%89%93%E5%BC%80%E5%90%8C%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6.png" class="">

<p>多个进程读取同一文件都能正确工作，每个进程都有它自己的文件表项，其中也有它自己的当前文件偏移量。但是，当多个进程写同一文件时，则可能产生预想不到的结果。</p>
<h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><ol>
<li>打开文件时设置 <code>O_APPEND</code> 标志是一种原子操作。</li>
<li>函数 <code>pread</code> 和 <code>pwrite</code> 是一种原子操作。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pread</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pwrite</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><code>open</code> 函数的 <code>O_CREAT</code> 和 <code>O_EXCL</code> 选项创建一个文件是原子操作。</li>
</ol>
<h2 id="函数-dup-和-dup2"><a href="#函数-dup-和-dup2" class="headerlink" title="函数 dup 和 dup2"></a>函数 dup 和 dup2</h2><p>下面两个函数都可用来复制一个现有的文件描述符。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> fd2)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>返回值：</strong></p>
<ul>
<li>若成功，返回新的文件描述符；</li>
<li>若出错，返回 −1。</li>
</ul>
<p>由 <code>dup</code> 返回的新文件描述符一定是当前可用文件描述符中的最小数值。</p>
<p>对于 <code>dup2</code>，可以用 fd2 参数指定新描述符的值。</p>
<ul>
<li>如果 fd2 已经打开，则先将其关闭。</li>
<li>如若 fd 等于 fd2，则 <code>dup2</code> 返回 fd2，而不关闭它。</li>
</ul>
<p><strong>这些函数返回的新文件描述符与参数 fd 共享同一个文件表项。</strong></p>
<img src="/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B03-%E6%96%87%E4%BB%B6IO/dup%E5%90%8E%E7%9A%84%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" class="">

<p>复制一个描述符的另一种方法是使用 <code>fcntl</code> 函数。</p>
<p>例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_dup</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd, new_fd;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *data = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    fd = open(<span class="string">&quot;test.txt&quot;</span>, O_CREAT | O_RDWR, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;打开文件失败.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 复制文件描述符</span></span><br><span class="line">    new_fd = dup(fd);</span><br><span class="line">    <span class="keyword">if</span> (new_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;复制文件描述符失败.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用原子操作读写文件</span></span><br><span class="line">    pwrite(new_fd, data, <span class="built_in">strlen</span>(data), SEEK_SET);</span><br><span class="line">    pread(fd, buf, <span class="number">128</span>, SEEK_SET);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd = %d, new_fd = %d, buf = %s\n&quot;</span>, fd, new_fd, buf);</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    close(new_fd);</span><br><span class="line">    <span class="comment">// 删除文件</span></span><br><span class="line">    unlink(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_dup2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd, new_fd;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *data = <span class="string">&quot;Hello, world!&quot;</span>;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    fd = open(<span class="string">&quot;example.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法打开文件&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 复制文件描述符到指定的文件描述符</span></span><br><span class="line">    new_fd = dup2(fd, <span class="number">100</span>); <span class="comment">// 将文件描述符复制到文件描述符100</span></span><br><span class="line">    <span class="comment">// 在新的文件描述符上写入数据</span></span><br><span class="line">    pwrite(new_fd, data, <span class="built_in">strlen</span>(data), SEEK_SET);</span><br><span class="line">    pread(fd, buf, <span class="number">128</span>, SEEK_SET);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd = %d, new_fd = %d, buf = %s\n&quot;</span>, fd, new_fd, buf);</span><br><span class="line">    <span class="comment">// 关闭文件描述符</span></span><br><span class="line">    close(fd);</span><br><span class="line">    close(new_fd);</span><br><span class="line">    <span class="comment">// 删除文件</span></span><br><span class="line">    unlink(<span class="string">&quot;example.txt&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span>&#123;</span><br><span class="line">    my_dup();</span><br><span class="line">    my_dup2();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc 05dup.c</span><br><span class="line">$ ./a.out</span><br><span class="line">fd = 3, new_fd = 4, buf = hello</span><br><span class="line">fd = 3, new_fd = 100, buf = Hello, world!</span><br></pre></td></tr></table></figure>

<h2 id="函数-sync、fsync-和-fdatasync"><a href="#函数-sync、fsync-和-fdatasync" class="headerlink" title="函数 sync、fsync 和 fdatasync"></a>函数 sync、fsync 和 fdatasync</h2><p>传统的 UNIX 系统实现在内核中设有缓冲区高速缓存或页高速缓存，大多数磁盘 <code>I/O</code> 都通过缓冲区进行。当我们向文件写入数据时，内核通常先将数据复制到缓冲区中，然后排入队列，晚些时候再写入磁盘。</p>
<p>通常，当内核需要重用缓冲区来存放其他磁盘块数据时，它会把所有延迟写数据块写入磁盘。为了保证磁盘上实际文件系统与缓冲区中内容的一致性，UNIX 系统提供了 <code>sync</code>、<code>fsync</code> 和 <code>fdatasync</code> 三个函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsync</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fdatasync</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sync</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>返回值：</strong></p>
<ul>
<li>若成功，返回 0；</li>
<li>若出错，返回 −1。</li>
</ul>
<p><code>sync</code> 只是将所有修改过的块缓冲区排入写队列，然后就返回，它并不等待实际写磁盘操作结束。</p>
<p><code>fsync</code> 函数只对由文件描述符 fd 指定的一个文件起作用，并且等待写磁盘操作结束才返回。</p>
<p><code>fdatasync</code> 函数类似于 <code>fsync</code>，但它只影响文件的数据部分。而除数据外，<code>fsync</code> 还会同步更新文件的属性。</p>
<blockquote>
<p><code>update</code> 守护进程会周期性的调用 <code>sync</code> 函数。命令 <code>sync</code> 也会调用 <code>sync</code> 函数。</p>
</blockquote>
<h2 id="函数-fcntl"><a href="#函数-fcntl" class="headerlink" title="函数 fcntl"></a>函数 fcntl</h2><p><code>fcntl</code> 函数可以改变已经打开文件的属性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* int arg */</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li>若成功，则依赖于 cmd；</li>
<li>若出错，返回 −1。</li>
</ul>
<p>参数：</p>
<p>fd 是文件描述符，cmd 是控制命令，arg 是与控制命令相关的参数，具体取决于控制命令的类型。</p>
<ul>
<li>cmd 为 <code>F_DUPFD</code> 时，复制文件描述符 fd。新文件描述符作为函数值返回。其 <code>FD_CLOEXEC</code> 文件描述符标志被清除。arg 表示要复制的最低可用文件描述符号。</li>
<li>cmd 为 <code>F_DUPFD_CLOEXEC</code> 时， 复制文件描述符，设置与新描述符关联的 <code>FD_CLOEXEC</code> 文件描述符标志的值，返回新文件描述符。arg 表示要复制的最低可用文件描述符号。</li>
<li>cmd 为 <code>F_GETFD</code> 时， 对应 fd 的文件描述符标志作为函数值返回。当前只定义了一个文件描述符标志 <code>FD_CLOEXEC</code>。arg 通常是 0。</li>
<li>cmd 为 <code>F_SETFD</code> 时， 对应 fd 设置文件描述符标志。arg 表示要设置的文件描述符标志。</li>
<li>cmd 为 <code>F_GETFL</code> 时， 对应 fd 的文件状态标志作为函数值返回。arg 通常是 0。</li>
<li>cmd 为 <code>F_SETFL</code> 时， 设置文件状态标志。arg 表示要设置的文件状态标志。</li>
<li>cmd 为 <code>F_GETOWN</code> 时， 获取当前接收 <code>SIGIO</code> 和 <code>SIGURG</code> 信号的进程 ID 或进程组 ID。arg 通常是 0。</li>
<li>cmd 为 <code>F_SETOWN</code> 时， 设置接收 <code>SIGIO</code> 和 <code>SIGURG</code> 信号的进程 ID 或进程组 ID。正的 arg 指定一个进程 ID，负的 arg 表示等于 arg 绝对值的一个进程组 ID。</li>
</ul>
<p>说明：</p>
<p><code>fcntl</code> 函数有以下 5 种功能。</p>
<ul>
<li>复制一个已有的描述符（<code>cmd=F_DUPFD</code> 或 <code>F_DUPFD_CLOEXEC</code>）。</li>
<li>获取&#x2F;设置文件描述符标志（<code>cmd=F_GETFD</code> 或 <code>F_SETFD</code>）。</li>
<li>获取&#x2F;设置文件状态标志（<code>cmd=F_GETFL</code> 或 <code>F_SETFL</code>）。</li>
<li>获取&#x2F;设置异步 <code>I/O</code> 所有权（<code>cmd=F_GETOWN</code> 或 <code>F_SETOWN</code>）。</li>
<li>获取&#x2F;设置记录锁（<code>cmd=F_GETLK</code>、<code>F_SETLK</code> 或 <code>F_SETLKW</code>）。</li>
</ul>
<blockquote>
<p>Linux 操作系统并不允许我们用 <code>fcntl</code> 设置 <code>O_SYNC</code> 标志，而是显示失败但没有返回出错。</p>
</blockquote>
<p>例子，对于指定的描述符打印文件标志。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_fl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> flags)</span>&#123;</span><br><span class="line">	<span class="type">int</span> val;</span><br><span class="line">	<span class="keyword">if</span> ((val = fcntl(fd, F_GETFL, <span class="number">0</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fcntl G_GETFL error.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 开启一个或多个文件状态标志</span></span><br><span class="line">	val |= flags;</span><br><span class="line">	<span class="keyword">if</span>(fcntl(fd, F_SETFL, val) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fcntl F_SETFL error.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_fl</span><span class="params">(<span class="type">int</span> fd)</span>&#123;</span><br><span class="line">	<span class="type">int</span> val;</span><br><span class="line">	<span class="keyword">if</span>((val = fcntl(fd, F_GETFL, <span class="number">0</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fcntl error for fd %d\n&quot;</span>, fd);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> (val &amp; O_ACCMODE)&#123; <span class="comment">// 必须用屏蔽字 O_ACCMODE 取得访问方式位</span></span><br><span class="line">		<span class="keyword">case</span> O_RDONLY:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;read only&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> O_WRONLY:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;write only&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> O_RDWR:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;read write&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;unkown access mode&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(val &amp; O_APPEND)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;, apend&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(val &amp; O_NONBLOCK)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;, nonblocking&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(val &amp; O_SYNC)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;, synchronous write&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="meta">#<span class="keyword">if</span> !defined(_POSIX_C_SOURCE) &amp;&amp; defined(O_FSYNC) &amp;&amp; (O_FSYNC != OSYNC)</span></span><br><span class="line">		<span class="keyword">if</span>(val &amp; O_FSYNC)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;, synchronous write&quot;</span>);</span><br><span class="line">	<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span>&#123;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;usage: a.out &lt;descriptor&gt;&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	fd = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">	print_fl(fd);</span><br><span class="line">	set_fl(fd, O_APPEND); <span class="comment">//</span></span><br><span class="line">	print_fl(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ gcc 06fcntl.c</span><br><span class="line">$ ./a.out 0 &lt; /dev/tty  <span class="comment"># 将 /dev/tty 重定向到文件描述符 0</span></span><br><span class="line"><span class="built_in">read</span> only</span><br><span class="line"><span class="built_in">read</span> only, apend</span><br><span class="line">$ ./a.out 1 &gt; tmp.foo <span class="comment"># 将文件描述符 1 重定向到 tmp.foo</span></span><br><span class="line">$ <span class="built_in">cat</span> tmp.foo</span><br><span class="line">write only</span><br><span class="line">write only, apend</span><br><span class="line">$ ./a.out 2 2&gt;&gt;tmp.foo <span class="comment"># 将文件描述符 2 追加到 tmp.foo</span></span><br><span class="line">write only, append</span><br><span class="line">write only, append</span><br><span class="line">$ ./a.out 5 5&lt;&gt;tmp.foo <span class="comment"># 5&lt;&gt;tmp.foo 表示将文件描述符5与文件 temp.foo 关联</span></span><br><span class="line"><span class="built_in">read</span> write</span><br><span class="line"><span class="built_in">read</span> write, apend</span><br></pre></td></tr></table></figure>

<h2 id="函数-ioctl"><a href="#函数-ioctl" class="headerlink" title="函数 ioctl"></a>函数 ioctl</h2><p><code>ioctl</code> 函数一直是 <code>I/O</code> 操作的杂物箱，终端 <code>I/O</code> 是使用 <code>ioctl</code> 最多的地方</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> <span class="comment">/* System V */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span> <span class="comment">/* BSD and Linux */</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> request, ...)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>返回值：</strong></p>
<ul>
<li>若出错，返回 −1；</li>
<li>若成功，返回其他值。</li>
</ul>
<p>我们表示的只是 <code>ioctl</code> 函数本身所要求的头文件。通常，还要求另外的设备专用头文件。</p>
<p>每个设备驱动程序可以定义它自己专用的一组 <code>ioctl</code> 命令，系统则为不同种类的设备提供通用的 <code>ioctl</code> 命令。</p>
<p>FreeBSD 中通用的 <code>ioctl</code> 操作：</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>常量名</th>
<th>头文件</th>
<th>ioctl 数</th>
</tr>
</thead>
<tbody><tr>
<td>盘标号</td>
<td>DIOxxx</td>
<td><code>&lt;sys/disklabel.h&gt;</code></td>
<td>4</td>
</tr>
<tr>
<td>文件 <code>I/O</code></td>
<td>FIOxxx</td>
<td><code>&lt;sys/filio.h&gt;</code></td>
<td>14</td>
</tr>
<tr>
<td>磁带 <code>I/O</code></td>
<td>MTIOxxx</td>
<td><code>&lt;sys/mtio.h&gt;</code></td>
<td>11</td>
</tr>
<tr>
<td>套接字 <code>I/O</code></td>
<td>SIOxxx</td>
<td><code>&lt;sys/sockio.h&gt;</code></td>
<td>73</td>
</tr>
<tr>
<td>终端 <code>I/O</code></td>
<td>TIOxxx</td>
<td><code>&lt;sys/ttycom.h&gt;</code></td>
<td>43</td>
</tr>
</tbody></table>
<h2 id="dev-fd"><a href="#dev-fd" class="headerlink" title="/dev/fd"></a><code>/dev/fd</code></h2><p>较新的系统都提供名为 <code>/dev/fd</code> 的目录，其目录项是名为 0、1、2 等的文件。打开文件 <code>/dev/fd/n</code> 等效于复制描述符 <code>n</code> 。</p>
<p>Linux 实现中的 <code>/dev/fd</code> 是个例外。它把文件描述符映射成指向底层物理文件的符号链接。</p>
<p><code>/dev/fd</code> 文件主要由 shell 使用，它允许使用路径名作为调用参数的程序，能用处理其他路径名的相同方式处理标准输入和输出。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/unix/" rel="tag"># unix</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B02-UNIX%E6%A0%87%E5%87%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/" rel="prev" title="unix环境高级编程02-UNIX标准及实现">
                  <i class="fa fa-chevron-left"></i> unix环境高级编程02-UNIX标准及实现
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B04-%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/" rel="next" title="unix环境高级编程04-文件和目录">
                  unix环境高级编程04-文件和目录 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CKCat</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/CKCat" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
